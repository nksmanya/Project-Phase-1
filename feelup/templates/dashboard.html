{% extends "base.html" %}
{% block title %}Dashboard - FeelUP{% endblock %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 style="font-size: 2rem; margin-bottom: 6px;">Welcome back, {{ user.name }}!</h2>
      <p class="text-muted" style="margin:0">A calm place to share & reflect â€” here's your summary for today.</p>
    </div>
    <div>
      <a href="{{ url_for('journal') }}" class="btn btn-sm btn-outline-primary me-2"><i class="fas fa-pen"></i> Journal</a>
      <a href="{{ url_for('memory') }}" class="btn btn-sm btn-primary"><i class="fas fa-book-open"></i> Memories</a>
    </div>
  </div>

  <div class="row gx-4">
    <!-- Main column -->
    <div class="col-lg-8">

      <!-- Top stats -->
      <div class="row mb-4">
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center p-3 shadow-hover card-premium">
            <i class="fas fa-heart" style="font-size: 1.6rem; color: #667eea;"></i>
            <div class="h4 mb-0">{{ moods|length }}</div>
            <small class="text-muted">Recent Moods</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center p-3 shadow-hover">
            <i class="fas fa-book-open" style="font-size: 1.6rem; color: #10b981;"></i>
            <div class="h4 mb-0">{{ suggestions|length }}</div>
            <small class="text-muted">Memory Suggestions</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center p-3 shadow-hover">
            <i class="fas fa-calendar-check" style="font-size: 1.6rem; color: #f59e0b;"></i>
            <div class="h4 mb-0">{{ events|length }}</div>
            <small class="text-muted">Upcoming</small>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center p-3 shadow-hover">
            <i class="fas fa-users" style="font-size: 1.6rem; color: #ef4444;"></i>
            <div class="h4 mb-0">{{ followed_users|length }}</div>
            <small class="text-muted">Following</small>
          </div>
        </div>
      </div>

      <!-- Recent mood posts -->
      <h3 class="mt-3 mb-3"><i class="fas fa-heartbeat" style="color: #667eea;"></i> Recent</h3>
      <div class="row">
        {% for mood in moods %}
        <div class="col-md-12 mb-3">
          <div class="card p-3 shadow-hover mood-card">
            <div class="d-flex gap-3 align-items-start">
              <div class="avatar">{{ mood.username[0]|upper }}</div>
              <div style="flex:1">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>{{ mood.username }}</strong>
                  <small class="text-muted">{{ mood.created_at.strftime('%b %d, %H:%M') }}</small>
                </div>
                <p style="margin:0 0 8px 0; line-height:1.5">{{ mood.content }}</p>
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    {% if mood.emotion == 'positive' %}
                      <span class="emotion-badge emotion-positive"><i class="fas fa-smile-beam"></i> {{ mood.emotion }}</span>
                    {% elif mood.emotion == 'negative' %}
                      <span class="emotion-badge emotion-negative"><i class="fas fa-sad-tear"></i> {{ mood.emotion }}</span>
                    {% else %}
                      <span class="emotion-badge emotion-neutral"><i class="fas fa-meh"></i> {{ mood.emotion }}</span>
                    {% endif %}
                  </div>
                  <div>
                    <a href="{{ url_for('mood_feed') }}" class="btn btn-sm btn-outline-primary">View Thread</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if not moods %}
      <div class="text-center py-4 card">
        <i class="fas fa-heart" style="font-size: 3rem; color: #d1d5db;"></i>
        <p class="text-muted mt-3">No recent moods to display</p>
        <a href="{{ url_for('mood_feed') }}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Share Your First Mood
        </a>
      </div>
      {% endif %}

      <!-- Journal Analytics -->
      <h3 class="mt-4 mb-3"><i class="fas fa-chart-line" style="color: #667eea;"></i> Your Mood Journal (Last 7 Days)</h3>
      {% if journal_scores %}
      <div class="card p-3 shadow-hover mb-4">
        <canvas id="journalChart" height="100"></canvas>
      </div>
      {% else %}
      <div class="text-center py-4 card mb-4">
        <i class="fas fa-pen-fancy" style="font-size: 3rem; color: #d1d5db;"></i>
        <p class="text-muted mt-3">No journal entries yet</p>
        <a href="{{ url_for('journal') }}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Start Journaling
        </a>
      </div>
      {% endif %}

      <!-- Weekly Mood (last 7 days) -->
      <h3 class="mt-4 mb-3"><i class="fas fa-clock" style="color: #10b981;"></i> Weekly Check-ins</h3>
      <div class="card p-3 shadow-hover mb-4">
        <canvas id="weeklyMoodChart" height="80"></canvas>
      </div>

      <!-- 30-day Overview -->
      <h3 class="mt-4 mb-3"><i class="fas fa-calendar-day" style="color: #f59e0b;"></i> Last 30 Days</h3>
      <div class="card p-3 shadow-hover mb-4">
        <canvas id="monthlyMoodChart" height="120"></canvas>
      </div>

      <!-- Mood Distribution -->
      <div class="card p-3 shadow-hover mb-4">
        <h6 class="mb-3">Mood Distribution (30 days)</h6>
        <canvas id="moodDistChart" height="80"></canvas>
      </div>

    </div>

    <!-- Right sidebar -->
    <div class="col-lg-4">
      <div class="sidebar">
        <div class="resource-card mb-3">
          <h5 style="margin-bottom:8px;">Daily Check-In</h5>
          <p class="text-muted" style="margin:0 0 8px 0">Take a moment to breathe. Try a 60-second grounding exercise.</p>
          <a href="https://www.mentalhealth.gov" target="_blank" class="btn btn-sm btn-outline-primary">Learn More</a>
        </div>

        <div class="resource-card mb-3">
          <h6>Upcoming Events</h6>
          {% for ev in events %}
            <div style="margin-bottom:8px;">
              <strong>{{ ev.title }}</strong>
              <div class="text-muted" style="font-size:0.9rem">{{ ev.datetime_event.strftime('%b %d, %H:%M') }}</div>
            </div>
          {% else %}
            <p class="text-muted">No upcoming events</p>
          {% endfor %}
        </div>

        <div class="resource-card mb-3">
          <h6>Helpful Resources</h6>
          <ul class="list-unstyled mb-0">
            <li><a href="#">Breathing exercises</a></li>
            <li><a href="#">Short meditations</a></li>
            <li><a href="#">Talk to a friend</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
{% if journal_scores %}
var ctx = document.getElementById('journalChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ journal_dates|tojson }},
        datasets: [{
            label: 'Sentiment Score',
            data: {{ journal_scores|tojson }},
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.12)',
            fill: true,
            tension: 0.36,
            borderWidth: 3,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: { backgroundColor: 'rgba(31,41,55,0.9)' }
        },
        scales: { y: { min: -1, max: 1 }, x: {} }
    }
});
{% endif %}
</script>

<script>
// Weekly mood chart
{% if weekly_labels and weekly_scores %}
var wCtx = document.getElementById('weeklyMoodChart').getContext('2d');
new Chart(wCtx, {
  type: 'line',
  data: {
    labels: {{ weekly_labels|tojson }},
    datasets: [{
      label: 'Avg Mood Score',
      data: {{ weekly_scores|tojson }},
      borderColor: '#10b981',
      backgroundColor: 'rgba(16,185,129,0.12)',
      fill: true,
      tension: 0.36,
      borderWidth: 3,
      pointRadius: 4
    }]
  },
  options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { min: -1, max: 1 } } }
});
{% endif %}

// 30-day monthly chart (bars colored by average mood)
{% if monthly_labels and monthly_avgs %}
var mCtx = document.getElementById('monthlyMoodChart').getContext('2d');
var monthlyColors = (function(vals){
  return vals.map(function(v){
    if(v === 0) return 'rgba(209,213,219,0.6)';
    if(v >= 0.3) return 'rgba(34,197,94,0.85)';
    if(v >= 0) return 'rgba(96,165,250,0.85)';
    return 'rgba(239,68,68,0.85)';
  });
})({{ monthly_avgs|tojson }});

new Chart(mCtx, {
  type: 'bar',
  data: {
    labels: {{ monthly_labels|tojson }},
    datasets: [{
      label: 'Avg Mood',
      data: {{ monthly_avgs|tojson }},
      backgroundColor: monthlyColors,
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } }, y: { min: -1, max: 1 } }
  }
});
{% endif %}

// Mood distribution pie
{% if dist_labels and dist_counts %}
var dCtx = document.getElementById('moodDistChart').getContext('2d');
new Chart(dCtx, {
  type: 'pie',
  data: {
    labels: {{ dist_labels|tojson }},
    datasets: [{ data: {{ dist_counts|tojson }}, backgroundColor: ['#10b981','#667eea','#f59e0b','#ef4444','#9CA3AF'] }]
  },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});
{% endif %}
</script>

{% endblock %}
